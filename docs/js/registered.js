var feeForAdult=1e3,feeForChild=800;function setTwCitySelector(e){new TwCitySelector;new TwCitySelector({el:e,hasZipcode:!1})}function countFee(){var e=0,a=parseInt($('input[name="numberOfAdults"]:checked').val()),n=parseInt($('input[name="numberOfChildren"]:checked').val());isFree()||(e=a*feeForAdult+n*feeForChild),e=FormatNumber(e),$("#feeByMember").html(e)}function isFree(){var e=!1;return"2020-07-25"==$('input[name="planDate"]:checked').val()&&(e=!0),e}function appendAvailableDate(e){var a="",n="",r="",t="",d=!1;_.each(e,(function(e,i){var l=e.planType,s="";"T1"==l?s="第一航廈團":"T2"==l&&(s="第二航廈團");var o=e.date,p=e.remainingQuota,c=e.dayOfWeek,u=e.id,v="";d||0==p||(v="checked",d=!0),a='<div class="column-x2"><input name="planDate" id="'+u+'" type="radio" data-plan-type="'+l+'" value="'+o+'" '+v+" "+(0==p?"disabled":"")+">"+o+"("+c+") "+s+'<font class="red">(剩餘：'+p+"人)</font></div>","2020-07-25"==o?n+=a:"六"==c||"日"==c?t+=a:r+=a})),$("#free-available-date").empty(),$("#free-available-date").append(n),$("#weekdays-available-date").empty(),$("#weekdays-available-date").append(r),$("#weekend-available-date").empty(),$("#weekend-available-date").append(t),countFee(),$('input[name="planDate"]').change((function(){countFee()}))}function setPlan(){getPlan().then((function(e){appendAvailableDate(e.data)}))}function appendPeopleForm(){var e,a="",n=$(".person-table-box").length,r="";0==n?(a="主要聯絡人",r="main-contact"):a="團員姓名"+n,e='<div class="person-table-box"><div class="caption '+r+'">'+a+'：</div><div class="column"><input id="name-'+n+'" type="text"><font id="error-name-'+n+'" class="red error hide">請填寫</font></div><div class="caption">性別：</div><div class="column"><input name="gender-'+n+'" type="radio" value="男" checked>男&nbsp;&nbsp;<input name="gender-'+n+'" type="radio" value="女">女</div><div class="caption">出生年月日：</div><div class="column"><input id="dateOfBirth-'+n+'"type="date" class="ymd" value="2000-01-01" max="2014-09-01"><font id="error-dateOfBirth-'+n+'" class="red error hide">請填寫</font></div><div class="caption">國籍：</div><div class="column"><input name="country-'+n+'" type="radio" value="本國籍" checked>本國籍&nbsp;&nbsp;<input name="country-'+n+'" type="radio" value="非本國籍">非本國籍</div><div class="caption">身分證：<br></div><div class="column"><input id="numberOfIdCard-'+n+'" type="text"><font id="error-numberOfIdCard-'+n+'" class="red error hide">請正確填寫</font><br><font class="ssmall">(非本國籍請填寫護照號碼)</font></div><div class="caption">地址：</div><div class="column"><div id="city-'+n+'" class="twcity"></div><input id="address-'+n+'" type="text" class="add"><font id="error-address-'+n+'" class="red error hide">請填寫</font></div><div class="caption">電話：</div><div class="column"><input id="phone-'+n+'" type="text"><font id="error-phone-'+n+'" class="red error hide">請填寫</font></div><div class="caption">Mail：</div><div class="column"><input id="email-'+n+'" type="text"><font id="error-email-'+n+'" class="red error hide">請填寫</font></div><div class="caption">用餐需求：</div><div class="column"><input name="eatingHabits-'+n+'" type="radio" value="葷" checked>葷&nbsp;&nbsp;&nbsp;<input name="eatingHabits-'+n+'" type="radio" value="素">素&nbsp;&nbsp;&nbsp;<input name="eatingHabits-'+n+'" type="radio" value="其他">其他 <input type="text" class="other"></div></div>',$("#people-forms").append(e),setTwCitySelector("#city-"+n)}function checkFormValid(){var e=!1;null==$('input[name="planDate"]:checked').val()?($(".error-planDate").removeClass("hide"),e=!0):$(".error-planDate").addClass("hide");var a=$(".person-table-box").length,n=parseInt($('input[name="numberOfAdults"]:checked').val()),r=parseInt($('input[name="numberOfChildren"]:checked').val()),t=0,d=0;for(p=0;p<a;p++){var i=$("#name-"+p).val(),l=$("#dateOfBirth-"+p).val(),s=calculate_age(l);s>=6&&s<12?t+=1:s>=12&&(d+=1);var o=$('input[name="country-'+p+'"]:checked').val(),c=$("#numberOfIdCard-"+p).val(),u=$("#city-"+p+" .county").val(),v=$("#city-"+p+" .district").val(),m=$("#address-"+p).val(),h=$("#phone-"+p).val(),f=$("#email-"+p).val();if(""==i?($("#error-name-"+p).removeClass("hide"),e=!0):$("#error-name-"+p).addClass("hide"),10!=l.length?($("#error-dateOfBirth-"+p).removeClass("hide"),e=!0):$("#error-dateOfBirth-"+p).addClass("hide"),"本國籍"==o)validateID(c)?$("#error-numberOfIdCard-"+p).addClass("hide"):($("#error-numberOfIdCard-"+p).removeClass("hide"),e=!0);else""==c?($("#error-numberOfIdCard-"+p).removeClass("hide"),e=!0):$("#error-numberOfIdCard-"+p).addClass("hide");""==u||""==v||""==m?($("#error-address-"+p).removeClass("hide"),e=!0):$("#error-address-"+p).addClass("hide"),0==h.length?($("#error-phone-"+p).removeClass("hide"),e=!0):$("#error-phone-"+p).addClass("hide"),0==f.length?($("#error-email-"+p).removeClass("hide"),e=!0):ValidateEmail(f)?$("#error-email-"+p).addClass("hide"):($("#error-email-"+p).removeClass("hide"),e=!0)}return d!=n||t!=r?($("#error-numberOfMember").removeClass("hide"),e=!0):$("#error-numberOfMember").addClass("hide"),!e}$(document).ready((function(){setPlan(),appendPeopleForm()})),$('input[name="numberOfAdults"]').change((function(){countFee()})),$('input[name="numberOfChildren"]').change((function(){countFee()})),$("#appendForm").click((function(){appendPeopleForm()})),$("#postOrder").click((function(){if(checkFormValid())if(JSON.parse($('input[name="agree"]:checked').val())){var e=$('input[name="planDate"]:checked')[0].dataset.planType,a=$('input[name="planDate"]:checked').val(),n=parseInt($('input[name="numberOfAdults"]:checked').val()),r=parseInt($('input[name="numberOfChildren"]:checked').val()),t=JSON.parse($('input[name="accomodation"]:checked').val()),d=[],i=$(".person-table-box").length;for(p=0;p<i;p++){var l;l={name:$("#name-"+p).val(),gender:$('input[name="gender-'+p+'"]:checked').val(),dateOfBirth:$("#dateOfBirth-"+p).val(),numberOfIdCard:$("#numberOfIdCard-"+p).val(),address:$("#city-"+p+" .county").val()+$("#city-"+p+" .district").val()+$("#address-"+p).val(),phone:$("#phone-"+p).val(),email:$("#email-"+p).val(),eatingHabits:$('input[name="eatingHabits-'+p+'"]:checked').val()},d.push(l)}var s={planType:e,planDate:a,numberOfAdults:n,numberOfChildren:r,people:d,comment:"",accomodation:t};setLoading(!0),postOrder(s).done((function(e){if(data=e.data,"goToPay"==data.message){var a=data.paymentHtml;goToPay(a)}else"success"==data.message?(alert("報名成功"),window.location.href="/notice"):(alert("報名失敗"),window.location.href="/registered")})).fail((function(e){alert("Oops! Something wrong!")})).always((function(){setLoading(!1)}))}else alert("請勾選同意");else alert("請完成必填欄位")}));
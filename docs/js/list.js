var resultAvailablePlanType=[],resultAvailablePlanDate=[];function setPlanType(e){var t=[],a="";_.each(e,(function(e){var n=e.planType;t.includes(n)||(t.push(n),a+="<option>"+n+"</option>")})),$("#planType").empty(),$("#planType").append(a)}function setPlanDate(){getPlan().then((function(e){plans=e.data;var t=$("#planType").val();plans=_.filter(plans,{planType:t});var a=[],n="";_.each(plans,(function(e){var t=e.date,p=e.dayOfWeek;a.includes(t)||(a.push(t),n+="<option>"+t+"("+p+")</option>")})),$("#planDate").empty(),$("#planDate").append(n)}))}function getAvailablePlans(){getAvailablePlan().then((function(e){var t=e.data;_.each(t,(function(e){var t={planType:e.planType,planDate:e.date};getGroupInPlan(t).then((function(t){var a=t.data;e.groups=a}))})),getOrders(t)}))}function getOrders(e){getOrder().then((function(t){orders=t.data;var a="";resultAvailablePlanType=_.map(_.uniqBy(e,"planType"),"planType"),_.each(orders,(function(t){var n,p,l=t.accomodation?"有":"無",d=t.numberOfAdults,o=t.numberOfChildren,i="",c=_.map(_.uniqBy(_.filter(e,{planType:t.planType}),"date"),"date"),r=_.filter(_.filter(e,{planType:t.planType}),{date:t.planDate})[0].groups;_.each(resultAvailablePlanType,(function(e){var a=e==t.planType?"selected":"";n+="<option "+a+">"+e+"</option>"})),_.each(c,(function(e){var a=e==t.planDate?"selected":"";p+="<option "+a+">"+e+"</option>"})),_.each(r,(function(e,a){var n=a==t.groupId?"selected":"";i+="<option "+n+' value="'+a+'">'+e+"</option>"})),a+="<tr><td>"+t.id+'</td><td><select id="select_type_'+t.id+'" data-order-id="'+t.id+'">'+n+'</select></td><td><select id="select_date_'+t.id+'" data-order-id="'+t.id+'">'+p+"</select></td><td>"+t.people[0].name+"</td><td>"+t.people[0].email+"</td><td>"+d+"</td><td>"+o+"</td><td>"+(d+o)+"</td><td>"+l+'</td><td><select id="select_group_'+t.id+'">'+i+'</select></td><td><input type="button" value="查詢"></td><td><textarea>'+t.comment+"</textarea></td><td>成功</td><td>"+t.paymentMerchantTradeNo+"</td><td>"+t.registrationDate+'</td><td><input type="button" value="儲存"></td></tr>'})),$("#list").empty(),$("#list").append(a),$("select[id^='select_type_']").change((function(e){var t=e.target.value,a=e.target.dataset.orderId;getAvailablePlan().then((function(e){var n=_.filter(e.data,{planType:t}),p=_.map(_.uniqBy(n,"date"),"date"),l="<option selected>請選擇</option>";_.each(p,(function(e){l+="<option>"+e+"</option>"})),$("#select_date_"+a).empty(),$("#select_date_"+a).append(l),$("#select_group_"+a).empty(),$("#select_group_"+a).append("<option selected>請選擇</option>")}))})),$("select[id^='select_date_']").change((function(e){var t=e.target.dataset.orderId,a="<option selected>請選擇</option>",n={planType:$("#select_type_"+t).val(),planDate:$("#select_date_"+t).val()};getGroupInPlan(n).then((function(e){var n=e.data;_.each(n,(function(e){a+="<option>"+e+"</option>"})),$("#select_group_"+t).empty(),$("#select_group_"+t).append(a)})).catch((function(){$("#select_group_"+t).empty(),$("#select_group_"+t).append(a)}))}))}))}$(document).ready((function(){getPlan().then((function(e){plans=e.data,setPlanType(plans),setPlanDate()})),$("#planType").change((function(){setPlanDate()})),$("#search").keyup((function(){var e=$(this).val().toLowerCase();$("#list tr").filter((function(){$(this).toggle($(this).text().toLowerCase().indexOf(e)>-1)}))})),getAvailablePlans()}));
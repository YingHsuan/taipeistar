var resultAvailablePlanType=[],resultAvailablePlanDate=[],feeForAdult=1e3,feeForChild=800;function checkEnableSendMail(){var e=$("#planType").val(),a=$("#planDate").val(),t=$("#planGroup").val();"不限"==e||"不限"==a||"不限"==t?$("#send-mail").prop("disabled",!0):$("#send-mail").prop("disabled",!1)}function setPlanType(e){var a=[],t="<option selected>不限</option>";_.each(e,(function(e){var n=e.planType;a.includes(n)||(a.push(n),t+="<option>"+n+"</option>")})),$("#planType").empty(),$("#planType").append(t)}function setPlanDate(){getPlan().then((function(e){plans=e.data;var a=$("#planType").val();plans=_.filter(plans,{planType:a});var t=[],n="<option selected>不限</option>";_.each(plans,(function(e){var a=e.date,l=e.dayOfWeek;t.includes(a)||(t.push(a),n+='<option value="'+a+'">'+a+"("+l+")</option>")})),$("#planDate").empty(),$("#planDate").append(n),setPlanGroup()}))}function setPlanGroup(){var e={planType:$("#planType").val(),planDate:$("#planDate").val()},a="<option selected>不限</option>";"不限"==$("#planType").val()||"不限"==$("#planDate").val()?($("#planGroup").empty(),$("#planGroup").append(a)):getGroupInPlan(e).done((function(e){var t=e.data;_.each(t,(function(e,t){a+='<option value="'+t+'">'+t+"("+e+"人)</option>"})),$("#planGroup").empty(),$("#planGroup").append(a)})).fail((function(){$("#planGroup").empty(),$("#planGroup").append(a)}))}function getAvailablePlans(){getAvailablePlan().done((function(e){getOrders(e.data)}))}function getOrders(e){getOrder().done((function(a){orders=a.data;var n=$("#planType").val(),l=$("#planDate").val(),o=$("#planGroup").val();"不限"!=n&&(orders=_.filter(orders,{planType:n})),"不限"!=l&&(orders=_.filter(orders,{planDate:l})),"不限"!=o&&(orders=_.filter(orders,{groupName:o})),resultAvailablePlanType=_.map(_.uniqBy(e,"planType"),"planType"),$("#list").empty();var d=[],i=0;_.each(orders,(function(a,n){var l,o,p=a.accomodation?"有":"無",c=a.numberOfAdults,s=a.numberOfChildren,r="",u=_.map(_.filter(e,{planType:a.planType}),"date"),v=(_.filter(_.filter(e,{planType:a.planType}),{date:a.planDate}),!1);_.each(resultAvailablePlanType,(function(e){var t="";e==a.planType&&(t="selected",v=!0),l+="<option "+t+' value="'+e+'">'+e+"</option>"})),v||(l+='<option selected value="'+a.planType+'">'+t+"</option>");var f=!1;_.each(u,(function(e){var t="";e==a.planDate&&(t="selected",f=!0),o+="<option "+t+' value="'+e+'">'+e+" ("+a.planDayOfWeek+")</option>"})),f||(o+='<option selected value="'+a.planDate+'">'+a.planDate+" ("+a.planDayOfWeek+")</option>");var g="",m="";1==a.paymentDone&&0==a.deleted?g="selected":m="selected";var y={planType:a.planType,planDate:a.planDate};getGroupInPlan(y).done((function(e){var t=e.data;_.each(t,(function(e,t){var n=t==a.groupName?"selected":"";r+="<option "+n+' value="'+t+'">'+t+"</option>"})),d[n]="<tr><td>"+a.id+'</td><td><select id="select_type_'+a.id+'" data-order-id="'+a.id+'">'+l+'</select></td><td><select id="select_date_'+a.id+'" data-order-id="'+a.id+'">'+o+"</select></td><td>"+a.people[0].name+"</td><td>"+a.people[0].phone+"</td><td>"+c+"</td><td>"+s+"</td><td>"+(c+s)+"</td><td>"+p+'</td><td><select id="select_group_'+a.id+'" data-order-id="'+a.id+'">'+r+'</select></td><td><input id="getInfo_'+a.id+'" type="button" value="查詢" data-order-id="'+a.id+'"></td><td><textarea id="comment_'+a.id+'">'+a.comment+'</textarea></td><td><select id="select_paymentdone_'+a.id+'"><option value="true" '+g+'>成功</option><option value="false" '+m+">取消</option></select></td><td>"+a.paymentMerchantTradeNo+"</td><td>"+a.registrationDate+'</td><td><input id="saveInfo_'+a.id+'" type="button" value="儲存" data-order-id="'+a.id+'"></td></tr>'})).always((function(){(i+=1)==orders.length&&(_.each(d,(function(e){console.log(e),$("#list").append(e)})),$("select[id^='select_type_']").change((function(e){var a=e.target.value,t=e.target.dataset.orderId;getAvailablePlan().done((function(e){var n=_.filter(e.data,{planType:a}),l="<option selected>請選擇</option>";_.each(n,(function(e){l+='<option value="'+e.date+'">'+e.date+" ("+e.dayOfWeek+")</option>"})),$("#select_date_"+t).empty(),$("#select_date_"+t).append(l),$("#select_group_"+t).empty(),$("#select_group_"+t).append("<option selected>請選擇</option>"),checkSaveInfoStatus(t)}))})),$("select[id^='select_date_']").change((function(e){var a=e.target.dataset.orderId,t="<option selected>請選擇</option>",n={planType:$("#select_type_"+a).val(),planDate:$("#select_date_"+a).val()};getGroupInPlan(n).done((function(e){var n=e.data;_.each(n,(function(e,a){t+='<option value="'+a+'">'+a+"</option>"})),$("#select_group_"+a).empty(),$("#select_group_"+a).append(t),checkSaveInfoStatus(a)})).fail((function(){$("#select_group_"+a).empty(),$("#select_group_"+a).append(t)}))})),$("select[id^='select_group_']").change((function(e){checkSaveInfoStatus(e.target.dataset.orderId)})),$("input[id^='getInfo_']").click((function(e){setInfo(e.target.dataset.orderId)})),$("input[id^='saveInfo_']").click((function(e){saveInfo(e.target.dataset.orderId)})))}))}))})).fail((function(e){console.log(e)}))}function setInfo(e){getOrderById(e).then((function(e){var a=(f=e.data).id,t="";"T1"==f.planType?t="第一航廈團":"T2"==f.planType&&(t="第二航廈團");var n=f.planDate,l=f.accomodation?"有":"無",o=f.numberOfAdults,d=f.numberOfChildren,i=f.groupName,p=f.comment,c="取消";1==f.paymentDone&&0==f.deleted&&(c="成功");var s=c,r=f.paymentMerchantTradeNo,u=f.registrationDate,v="";_.each(f.people,(function(e,a){var t="";t=0==a?"主要連絡人":"團員姓名"+a;var n=e.name,l=e.gender;"M"==e.gender?l="男":"F"==e.gender&&(l="女");var o=e.dateOfBirth,d=e.numberOfIdCard,i=e.address,p=e.phone,c=e.email,s=e.eatingHabits;v+='<div class="column-half"><div class="caption">'+t+'：</div><div class="column">'+n+'</div><div class="caption">性別：</div><div class="column">'+l+'</div><div class="caption">出生年月日：</div><div class="column">'+o+'</div><div class="caption">身分證：</div><div class="column">'+d+'</div><div class="caption">地址：</div><div class="column">'+i+'</div><div class="caption">電話：</div><div class="column">'+p+'</div><div class="caption">Mail：</div><div class="column">'+c+'</div><div class="caption">用餐需求：</div><div class="column">'+s+"</div></div>"}));var f='<section id="team-infor-page"><div class="title">報名詳細資料</div><div class="column-half"><strong>序號：</strong>'+a+'</div><div class="column-half"><strong>報名行程：</strong>'+t+'</div><div class="column-half"><strong>報名時段：</strong>'+n+'</div><div class="column-half"><strong>住宿需求：</strong>'+l+'</div><div class="column-half"><strong>參加人數：</strong>大人 '+o+" 位, 小孩 "+d+" 位, 總共 "+(o+d)+' 人</div><div class="column-half"><strong>團號分配：</strong>'+i+'</div><div class="column-half"><strong>備註：</strong>'+p+'</div><div class="column-half"><strong>報名成功/取消：</strong>'+s+'</div><div class="column-half"><strong>綠界訂單編號：</strong>'+r+'</div><div class="column-half"><strong>報名時間：</strong>'+u+'</div><div class="column-full" style="text-align:right;"><font class="red"><strong>總計費用：</strong>'+(o*feeForAdult+d*feeForChild)+'NT</font></div><div class="column-full"><strong>參與團員請詳填個資</strong></div>'+v+"</section>";$.fancybox.open(f)}))}function checkSaveInfoStatus(e){var a=$("#select_type_"+e).val(),t=$("#select_date_"+e).val(),n=$("#select_group_"+e).val();"請選擇"==a||"請選擇"==t||"請選擇"==n?$("#saveInfo_"+e).prop("disabled",!0):$("#saveInfo_"+e).prop("disabled",!1)}function saveInfo(e){var a=$("#select_type_"+e).val(),t=$("#select_date_"+e).val(),n=$("#select_group_"+e).val(),l=$("#comment_"+e).val(),o=JSON.parse($("#select_paymentdone_"+e).val());if("請選擇"!=a&&"請選擇"!=t&&"請選擇"!=n){var d={planType:a=a,planDate:t=t,groupName:n=n,comment:l=l,paymentDone:o=o};patchOrderById(e,d).done((function(e){alert("儲存成功"),location.reload()})).fail((function(e){alert("儲存失敗")}))}}function sendMail(){var e=$("#planType").val(),a=$("#planDate").val(),t=$("#planGroup").val();postGroupMailNotification({planType:e,planDate:a,groupName:t}).then((function(e){console.log(e),alert("發送成功")}))}function exportOrders(){getExportOrders().done((function(e){console.log(e)})).fail((function(e){console.log(e)}))}$(document).ready((function(){$("#send-mail").prop("disabled",!0),getPlan().then((function(e){plans=e.data,setPlanType(plans),setPlanDate()})),$("#planType").change((function(){setPlanDate(),checkEnableSendMail()})),$("#planDate").change((function(){setPlanGroup(),checkEnableSendMail()})),$("#planGroup").change((function(){checkEnableSendMail()})),$("#search").keyup((function(){var e=$(this).val().toLowerCase();$("#list tr").filter((function(){$(this).toggle($(this).text().toLowerCase().indexOf(e)>-1)}))})),$("#search-button").click((function(){getAvailablePlans()})),$("#send-mail").click((function(){sendMail()})),$("#export-orders").click((function(){exportOrders()})),getAvailablePlans()}));
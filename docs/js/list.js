var resultAvailablePlanType=[],resultAvailablePlanDate=[],feeForAdult=1e3,feeForChild=800;function setPlanType(t){var e=[],a="<option selected>不限</option>";_.each(t,(function(t){var n=t.planType;e.includes(n)||(e.push(n),a+="<option>"+n+"</option>")})),$("#planType").empty(),$("#planType").append(a)}function setPlanDate(){getPlan().then((function(t){plans=t.data;var e=$("#planType").val();plans=_.filter(plans,{planType:e});var a=[],n="<option selected>不限</option>";_.each(plans,(function(t){var e=t.date,l=t.dayOfWeek;a.includes(e)||(a.push(e),n+='<option value="'+e+'">'+e+"("+l+")</option>")})),$("#planDate").empty(),$("#planDate").append(n),setPlanGroup()}))}function setPlanGroup(){var t={planType:$("#planType").val(),planDate:$("#planDate").val()},e="<option selected>不限</option>";"不限"==$("#planType").val()||"不限"==$("#planDate").val()?($("#planGroup").empty(),$("#planGroup").append(e)):getGroupInPlan(t).then((function(t){var a=t.data;_.each(a,(function(t,a){e+='<option value="'+a+'">'+a+"("+t+"人)</option>"})),$("#planGroup").empty(),$("#planGroup").append(e)})).catch((function(){$("#planGroup").empty(),$("#planGroup").append(e)}))}function getAvailablePlans(){getAvailablePlan().then((function(t){var e=t.data;_.each(e,(function(t){var e={planType:t.planType,planDate:t.date};getGroupInPlan(e).then((function(e){var a=e.data;t.groups=a}))})),getOrders(e)}))}function getOrders(t){getOrder().then((function(e){orders=e.data;var a=$("#planType").val(),n=$("#planDate").val(),l=$("#planGroup").val();"不限"!=a&&(orders=_.filter(orders,{planType:a})),"不限"!=n&&(orders=_.filter(orders,{planDate:n})),"不限"!=l&&(orders=_.filter(orders,{groupName:l}));var o="";resultAvailablePlanType=_.map(_.uniqBy(t,"planType"),"planType"),_.each(orders,(function(e){var a,n,l=e.accomodation?"有":"無",i=e.numberOfAdults,d=e.numberOfChildren,p="",s=_.map(_.uniqBy(_.filter(t,{planType:e.planType}),"date"),"date"),c=_.filter(_.filter(t,{planType:e.planType}),{date:e.planDate})[0].groups;_.each(resultAvailablePlanType,(function(t){var n=t==e.planType?"selected":"";a+="<option "+n+">"+t+"</option>"})),_.each(s,(function(t){var a=t==e.planDate?"selected":"";n+="<option "+a+">"+t+"</option>"})),_.each(c,(function(t,a){var n=a==e.groupName?"selected":"";p+="<option "+n+' value="'+t+'">'+a+"</option>"})),o+="<tr><td>"+e.id+'</td><td><select id="select_type_'+e.id+'" data-order-id="'+e.id+'">'+a+'</select></td><td><select id="select_date_'+e.id+'" data-order-id="'+e.id+'">'+n+"</select></td><td>"+e.people[0].name+"</td><td>"+e.people[0].email+"</td><td>"+i+"</td><td>"+d+"</td><td>"+(i+d)+"</td><td>"+l+'</td><td><select id="select_group_'+e.id+'">'+p+'</select></td><td><input id="getInfo_'+e.id+'" type="button" value="查詢" data-order-id="'+e.id+'"></td><td><textarea>'+e.comment+"</textarea></td><td>成功</td><td>"+e.paymentMerchantTradeNo+"</td><td>"+e.registrationDate+'</td><td><input type="button" value="儲存"></td></tr>'})),$("#list").empty(),$("#list").append(o),$("select[id^='select_type_']").change((function(t){var e=t.target.value,a=t.target.dataset.orderId;getAvailablePlan().then((function(t){var n=_.filter(t.data,{planType:e}),l=_.map(_.uniqBy(n,"date"),"date"),o="<option selected>請選擇</option>";_.each(l,(function(t){o+="<option>"+t+"</option>"})),$("#select_date_"+a).empty(),$("#select_date_"+a).append(o),$("#select_group_"+a).empty(),$("#select_group_"+a).append("<option selected>請選擇</option>")}))})),$("select[id^='select_date_']").change((function(t){var e=t.target.dataset.orderId,a="<option selected>請選擇</option>",n={planType:$("#select_type_"+e).val(),planDate:$("#select_date_"+e).val()};getGroupInPlan(n).then((function(t){var n=t.data;_.each(n,(function(t){a+="<option>"+t+"</option>"})),$("#select_group_"+e).empty(),$("#select_group_"+e).append(a)})).catch((function(){$("#select_group_"+e).empty(),$("#select_group_"+e).append(a)}))})),$("input[id^='getInfo_']").click((function(t){setInfo(t.target.dataset.orderId)}))}))}function setInfo(t){getOrderById(t).then((function(t){var e=(v=t.data).id,a="";"T1"==v.planType?a="第一航廈團":"T2"==v.planType&&(a="第二航廈團");var n=v.planDate,l=v.accomodation?"有":"無",o=v.numberOfAdults,i=v.numberOfChildren,d=v.groupName,p=v.comment,s=v.paymentDone?"成功":"取消",c=v.paymentMerchantTradeNo,r=v.registrationDate,u="";_.each(v.people,(function(t,e){var a="";a=0==e?"主要連絡人":"團員姓名"+e;var n=t.name,l=t.gender;"M"==t.gender?l="男":"F"==t.gender&&(l="女");var o=t.dateOfBirth,i=t.numberOfIdCard,d=t.address,p=t.phone,s=t.email,c=t.eatingHabits;u+='<div class="column-half"><div class="caption">'+a+'：</div><div class="column">'+n+'</div><div class="caption">性別：</div><div class="column">'+l+'</div><div class="caption">出生年月日：</div><div class="column">'+o+'</div><div class="caption">身分證：</div><div class="column">'+i+'</div><div class="caption">地址：</div><div class="column">'+d+'</div><div class="caption">電話：</div><div class="column">'+p+'</div><div class="caption">Mail：</div><div class="column">'+s+'</div><div class="caption">用餐需求：</div><div class="column">'+c+"</div></div>"}));var v='<section id="team-infor-page"><div class="title">報名詳細資料</div><div class="column-half"><strong>序號：</strong>'+e+'</div><div class="column-half"><strong>報名行程：</strong>'+a+'</div><div class="column-half"><strong>報名時段：</strong>'+n+'</div><div class="column-half"><strong>住宿需求：</strong>'+l+'</div><div class="column-half"><strong>參加人數：</strong>大人 '+o+" 位, 小孩 "+i+" 位, 總共 "+(o+i)+' 人</div><div class="column-half"><strong>團號分配：</strong>'+d+'</div><div class="column-half"><strong>備註：</strong>'+p+'</div><div class="column-half"><strong>報名成功/取消：</strong>'+s+'</div><div class="column-half"><strong>綠界訂單編號：</strong>'+c+'</div><div class="column-half"><strong>報名時間：</strong>'+r+'</div><div class="column-full" style="text-align:right;"><font class="red"><strong>總計費用：</strong>'+(o*feeForAdult+i*feeForChild)+'NT</font></div><div class="column-full"><strong>參與團員請詳填個資</strong></div>'+u+"</section>";$.fancybox.open(v)}))}$(document).ready((function(){getPlan().then((function(t){plans=t.data,setPlanType(plans),setPlanDate()})),$("#planType").change((function(){setPlanDate()})),$("#planDate").change((function(){setPlanGroup()})),$("#search").keyup((function(){var t=$(this).val().toLowerCase();$("#list tr").filter((function(){$(this).toggle($(this).text().toLowerCase().indexOf(t)>-1)}))})),$("#search-button").click((function(){getAvailablePlans()})),getAvailablePlans()}));